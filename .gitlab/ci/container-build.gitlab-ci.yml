.image-build-base:
  extends:
    - .dind
    - .default-retry
  image: ghcr.io/code0-tech/build-images/reticulum-builder:207.1-ruby-3.2.2
  stage: container
  variables:
    PLATFORM_ARGS: "--platform linux/amd64,linux/arm64"
  script:
    - source support/helpers.sh
    - docker_login
    - docker_setup_multi_arch
    - 'image=$(echo "$CI_JOB_NAME" | cut -d : -f 2)'
    - '[ -z "$NEED_PROJECT_DOWNLOAD" ] || download_project $image'
  retry:
    exit_codes:
      - 10 # when downloading project fails

.single-image-build-base:
  extends:
    - .image-build-base
  script:
    - !reference [.image-build-base, script]
    - build_image $image $CI_PIPELINE_ID "--push"

.variant-image-build-base:
  extends:
    - .image-build-base
  script:
    - !reference [.image-build-base, script]
    - build_image $image $CI_PIPELINE_ID "--build-arg VARIANT=$VARIANT --push" $(get_image_tag $CI_PIPELINE_ID $VARIANT)

container:mise:
  extends:
    - .single-image-build-base

container:rust:
  extends:
    - .single-image-build-base
  needs:
    - container:mise

container:aquila:
  extends:
    - .single-image-build-base
  needs:
    - container:rust
  variables:
    NEED_PROJECT_DOWNLOAD: 'true'

container:draco:
  extends:
    - .variant-image-build-base
  needs:
    - container:rust
  variables:
    NEED_PROJECT_DOWNLOAD: 'true'
  parallel:
    matrix:
      - VARIANT:
          - rest

container:taurus:
  extends:
    - .single-image-build-base
  needs:
    - container:rust
  variables:
    NEED_PROJECT_DOWNLOAD: 'true'

container:ruby:
  extends:
    - .single-image-build-base
  needs:
    - container:mise

container:postgresql:
  extends:
    - .single-image-build-base
  needs:
    - container:mise

container:sagittarius:
  extends:
    - .variant-image-build-base
  needs:
    - container:ruby
    - container:postgresql
  variables:
    NEED_PROJECT_DOWNLOAD: 'true'
  parallel:
    matrix:
      - VARIANT:
          - ce
          - ee
