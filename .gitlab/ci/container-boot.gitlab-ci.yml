.container:boot:
  extends:
    - .dind
  stage: container:boot
  image: ghcr.io/code0-tech/build-images/reticulum-builder:196.1-ruby-3.2.2
  variables:
    COMPOSE_FILE: support/docker-compose.yml

.container:boot:sagittarius:
  extends:
    - .container:boot
  needs:
    - container:sagittarius
  parallel:
    matrix:
      - SAGITTARIUS_VARIANT:
          - ce
          - ee
  before_script:
    - docker compose up postgres -d
    - docker compose up sagittarius-$SAGITTARIUS_SERVICE -d
    - docker ps --all
    - docker compose logs sagittarius-$SAGITTARIUS_SERVICE -f &

container:boot:sagittarius:rails-web:
  extends:
    - .container:boot:sagittarius
  variables:
    SAGITTARIUS_SERVICE: rails-web
  script:
    - docker compose run curl-sagittarius-rails-web

container:boot:sagittarius:grpc:
  extends:
    - .container:boot:sagittarius
  variables:
    SAGITTARIUS_SERVICE: grpc
  before_script:
    - bundle install
    - !reference [.container:boot:sagittarius, before_script]
  script:
    - support/grpc_check_health --host docker:50051 --service liveness --retries 20
    - support/grpc_check_health --host docker:50051 --service readiness --retries 20

container:boot:aquila:
  extends:
    - .container:boot
  needs:
    - container:aquila
    - container:sagittarius
  variables:
    SAGITTARIUS_VARIANT: ce
  script:
    - bundle install
    - docker compose up postgres -d
    - docker compose up nats -d
    - docker compose up sagittarius-grpc -d
    - docker ps --all
    - docker compose logs sagittarius-grpc -f &
    - support/grpc_check_health --host docker:50051 --service readiness --retries 20
    - docker compose up aquila -d
    - docker compose logs aquila -f &
    - support/grpc_check_health --host docker:8081 --service liveness --retries 20
    - support/grpc_check_health --host docker:8081 --service readiness --retries 20

container:boot:taurus:
  extends:
    - .container:boot
  needs:
    - container:taurus
  script:
    - bundle install
    - docker compose up nats -d
    - docker compose up taurus -d
    - docker compose logs taurus -f &
    - support/grpc_check_health --host docker:8082 --service liveness --retries 20
    - support/grpc_check_health --host docker:8082 --service readiness --retries 20

container:boot:draco:
  extends:
    - .container:boot
  needs:
    - container:draco
  parallel:
    matrix:
      - DRACO_VARIANT:
          - rest
  script:
    - bundle install
    - docker compose up nats -d
    - docker compose up draco -d
    - docker compose logs draco -f &
    - support/grpc_check_health --host docker:8083 --service liveness --retries 20
    - support/grpc_check_health --host docker:8083 --service readiness --retries 20
