upstream sagittarius_rails_web {
  server <%= env('SAGITTARIUS_RAILS_HOST') %>:<%= env('SAGITTARIUS_RAILS_PORT') %>;
}

upstream sagittarius_grpc {
  server <%= env('SAGITTARIUS_GRPC_HOST') %>:<%= env('SAGITTARIUS_GRPC_PORT') %>;
}

upstream sculptor {
  server <%= env('SCULPTOR_HOST') %>:<%= env('SCULPTOR_PORT') %>;
}

<% if env?('SSL_ENABLED') %>
server {
  listen 80;
  server_name <%= env('HOSTNAME') %>;

  return 301 https://$host$request_uri;
}

server {
  listen 443 ssl http2;
  server_name <%= env('HOSTNAME') %>;

  ssl_certificate /etc/nginx/certs/<%= env('SSL_CERT_FILE', "#{env('HOSTNAME')}.pem") %>;
  ssl_certificate_key /etc/nginx/certs/<%= env('SSL_KEY_FILE', "#{env('HOSTNAME')}.key") %>;

  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;
<% else %>
server {
  listen 80 http2;
  server_name <%= env('HOSTNAME') %>;
<% end %>

  location = /graphql {
    proxy_pass http://sagittarius_rails_web;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location = /files/upload {
    proxy_pass http://sagittarius_rails_web;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Increase limits for file uploads
    client_max_body_size 100M;
  }

  location = /health/liveness {
    proxy_pass http://sagittarius_rails_web;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location /good_job {
    proxy_pass http://sagittarius_rails_web;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  location = /error502grpc {
    internal;
    default_type application/grpc;
    add_header grpc-status 14;
    add_header grpc-message "unavailable";
    return 204;
  }

  location / {
    if ($content_type = "application/grpc") {
      grpc_pass grpc://sagittarius_grpc;
      error_page 502 = /error502grpc;
    }
    grpc_set_header X-Real-IP $remote_addr;
    grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # Disable buffering for streaming
    grpc_read_timeout 1h;
    grpc_send_timeout 1h;

    # Keep connection alive for long-running streams
    grpc_socket_keepalive on;

    proxy_pass http://sculptor;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
}
